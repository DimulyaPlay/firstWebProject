{% extends 'layout.html' %}

{% block content %}
<br>
<select id="certificateSelector" class="form-select"></select>
<br>

<table class="table table-hover">
    <thead>
      <tr style="text-align: center;">
        <th scope="col" class="col-md-4 align-middle" style="text-align: left;">Название файла</th>
        <th scope="col" class="col-md-2 align-middle">Создан</th>
        <th scope="col" class="col-md-2 align-middle">Открыть файл</th>
        <th scope="col" class="col-md-2 align-middle">Открыть письмо</th>
        <th scope="col" class="col-md-2 align-middle">Подписать</th>
      </tr>
    </thead>
    <tbody>
     
    {% if files %}
    
        {% for file in files %}
            {% if file.sigPath %}
            <tr class="table-success" style="text-align: center;" >
            {% else %}
            <tr class="table-warning" style="text-align: center;" data-toggle="modal" data-target="#myModal" data-message-id="{{ file.message_id }}">
            {% endif %}

            <th scope="row" style="text-align: left;" >{{ file.fileName }}</th>

            <td>{{ file.createDatetime.strftime('%d.%m.%y %H:%M') }}</td>       

            <td>
                <a href="{{ url_for('views.get_file', file_id=file.id) }}" target="_blank">
                    <img src="static/img/file-icon.png" alt="OpenFile">
                </a>
            </td>    

            <td>
                <img src="static/img/email-icon.png" alt="OpenLetter" data-toggle="modal" data-target="#myModal" data-message-id="{{ file.message_id }}">
            </td>   

            <td><button class="btn btn-primary btn-sign-file" data-file-id="{{ file.id }}">Подписать Файл</button></td>
        {% endfor %}
         
    {% else %}
    <tr>
        <th scope="row">Сообщений нет</th>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>        
    </tr> 
    {% endif %}
    
</tbody>
</table>

<nav aria-label="Page navigation" class="d-flex justify-content-center">
  <ul class="pagination">

      <li class="page-item {% if total_pages == 0 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('views.outbox', page=1, search=search_query) }}" tabindex="-1" aria-disabled="true">В начало</a>
      </li>
      <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('views.outbox', page=current_page-1 , search=search_query) }}" tabindex="-1" aria-disabled="true">Назад</a>
      </li>

      {% for page_num in range(start_index_pages, end_index_pages+1) %}
          <li class="page-item {% if page_num == current_page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('views.outbox', page=page_num, search=search_query) }}">{{ page_num }}</a>
          </li>
      {% endfor %}

      <li class="page-item {% if current_page + 1 > total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('views.outbox', page=current_page+1 , search=search_query) }}" tabindex="-1" aria-disabled="true">Вперед</a>
      </li>
      <li class="page-item {% if total_pages == 0 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('views.outbox', page=total_pages , search=search_query) }}" tabindex="-1" aria-disabled="true">В конец</a>
      </li>
  </ul>
</nav>


<br><br><br>
<table class="table table-hover">
    <thead>
        <tr>
          <th scope="col">Цветовая разметка</th>
        </tr>
        </thead>
    <tbody>
    <tr class="table-success">
      <th scope="row">Файл подписан</th>
    </tr>
    <tr class="table-warning">
      <th scope="row">Файл не подписан</th>
    </tr>
    </tbody>
  </table>

<script>
$(document).ready(function() {
    $.ajax({
        url: 'http://localhost:4999/get_certs',
        type: 'GET',
        success: function(data) {
            var certificates = data.certificates;
            var lastCert = data.last_cert;
            var $select = $('#certificateSelector');

            certificates.forEach(function(cert) {
                var isSelected = cert === lastCert ? 'selected' : '';
                $select.append(`<option value="${cert}" ${isSelected}>${cert}</option>`);
            });
        },
        error: function() {
            alert('Не удалось получить список сертификатов с локального сервера.');
        }
    });
});
</script>


{% endblock content %}

